@model IncosafCMS.Web.Models.PracticeExamTakeViewModel
@using IncosafCMS.Web.Helpers
@{
    ViewBag.Title = "Làm bài thi thử";
    Layout = "~/Views/Shared/_LayoutHome.cshtml";
}

<style>
    .take-page {
        height: 100%;
        display: flex;
        overflow: hidden;
        background: #f4f6f9;
    }

    /* Sidebar - Question Navigator */
    .take-sidebar {
        width: 280px;
        min-width: 280px;
        background: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e8ecf1;
        overflow: hidden;
    }

    .sidebar-header {
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .sidebar-header h5 {
        font-size: 14px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0 0 4px 0;
    }

    .sidebar-header .exam-title-text {
        font-size: 12px;
        color: #95a5a6;
        margin: 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .sidebar-timer {
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: #7f8c8d;
    }

    .sidebar-timer i { color: #ff9f43; }
    .sidebar-timer #elapsed { font-weight: 700; color: #2c3e50; font-size: 16px; }

    .question-nav {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .question-nav-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
    }

    .qnav-btn {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid #e0e6ed;
        border-radius: 10px;
        background: white;
        font-size: 13px;
        font-weight: 600;
        color: #7f8c8d;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qnav-btn:hover { border-color: #667eea; color: #667eea; }
    .qnav-btn.correct { background: #28c76f; border-color: #28c76f; color: white; }
    .qnav-btn.wrong { background: #ea5455; border-color: #ea5455; color: white; }
    .qnav-btn.answered { background: #95a5a6; border-color: #95a5a6; color: white; }
    .qnav-btn.current { border-color: #667eea; background: #667eea; color: white; box-shadow: 0 2px 8px rgba(102,126,234,0.4); }

    .sidebar-footer {
        padding: 16px 20px;
        border-top: 1px solid #f0f0f0;
    }

    .sidebar-progress {
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
    }

    .progress-bar-track {
        width: 100%;
        height: 6px;
        background: #e8ecf1;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 14px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(135deg, #28c76f 0%, #48dbad 100%);
        border-radius: 3px;
        transition: width 0.3s;
    }

    .btn-finish-exam {
        width: 100%;
        background: linear-gradient(135deg, #ea5455 0%, #f09819 100%);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-finish-exam:hover {
        box-shadow: 0 4px 15px rgba(234,84,85,0.4);
        transform: translateY(-1px);
    }

    .sidebar-extra-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }

    .btn-sidebar-action {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 13px;
        border: 2px solid #e0e6ed;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-sidebar-action:hover { transform: translateY(-1px); }

    .btn-sidebar-action.btn-pause {
        color: #ff9f43;
        border-color: rgba(255,159,67,0.3);
        background: rgba(255,159,67,0.06);
    }
    .btn-sidebar-action.btn-pause:hover {
        background: #ff9f43; color: white; border-color: #ff9f43;
        box-shadow: 0 4px 12px rgba(255,159,67,0.3);
    }

    .btn-sidebar-action.btn-reset {
        color: #667eea;
        border-color: rgba(102,126,234,0.3);
        background: rgba(102,126,234,0.06);
    }
    .btn-sidebar-action.btn-reset:hover {
        background: #667eea; color: white; border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }

    /* Main Content Area (center) */
    .take-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
    }

    .question-area {
        flex: 1;
        overflow-y: auto;
        padding: 32px 40px;
    }

    .question-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 24px;
    }

    .question-number {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;
        flex-shrink: 0;
    }

    .question-meta { flex: 1; }

    .question-meta h3 {
        font-size: 16px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0 0 2px 0;
    }

    .question-meta p {
        font-size: 13px;
        color: #95a5a6;
        margin: 0;
    }

    .question-text {
        font-size: 16px;
        line-height: 1.7;
        color: #2c3e50;
        margin-bottom: 28px;
        padding: 20px 24px;
        background: #fafbff;
        border-radius: 12px;
        border-left: 4px solid #667eea;
    }

    /* Answer Options */
    .answer-options { display: flex; flex-direction: column; gap: 12px; }

    .answer-option {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        padding: 16px 20px;
        border: 2px solid #e8ecf1;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        position: relative;
    }

    .answer-option:hover { border-color: #667eea; background: #f8f9ff; }

    .answer-option.selected {
        border-color: #667eea;
        background: rgba(102,126,234,0.06);
        box-shadow: 0 2px 10px rgba(102,126,234,0.15);
    }

    .answer-option.graded { cursor: default; pointer-events: none; }
    .answer-option.graded:hover { border-color: inherit; background: inherit; }

    .answer-option.graded.correct-answer {
        border-color: #28c76f;
        background: rgba(40,199,111,0.06);
    }

    .answer-option.graded.wrong-selected {
        border-color: #ea5455;
        background: rgba(234,84,85,0.06);
    }

    .answer-option input[type="radio"] { display: none; }

    .answer-label {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: #f4f6f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 15px;
        color: #7f8c8d;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .answer-option.selected .answer-label { background: #667eea; color: white; }
    .answer-option.graded.correct-answer .answer-label { background: #28c76f; color: white; }
    .answer-option.graded.wrong-selected .answer-label { background: #ea5455; color: white; }

    .answer-text {
        flex: 1;
        font-size: 15px;
        color: #2c3e50;
        line-height: 1.6;
        padding-top: 6px;
    }

    .answer-result-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        display: none;
    }

    .answer-option.graded.correct-answer .answer-result-icon {
        display: block;
        color: #28c76f;
    }
    .answer-option.graded.wrong-selected .answer-result-icon {
        display: block;
        color: #ea5455;
    }

    /* Grading feedback banner */
    .grading-feedback {
        margin-top: 20px;
        padding: 14px 20px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        display: none;
        align-items: center;
        gap: 10px;
    }

    .grading-feedback.correct {
        background: rgba(40,199,111,0.08);
        border: 1px solid rgba(40,199,111,0.2);
        color: #1e8449;
    }

    .grading-feedback.wrong {
        background: rgba(234,84,85,0.08);
        border: 1px solid rgba(234,84,85,0.2);
        color: #c0392b;
    }

    .grading-feedback i { font-size: 18px; }

    /* Navigation Buttons */
    .question-nav-buttons {
        padding: 16px 40px;
        border-top: 1px solid #f0f0f0;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-nav {
        padding: 10px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        border: 2px solid #e0e6ed;
        background: white;
        color: #5a6c7d;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-nav:hover { border-color: #667eea; color: #667eea; }

    .btn-nav.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    .btn-nav.primary:hover { box-shadow: 0 4px 12px rgba(102,126,234,0.4); }

    .btn-nav:disabled { opacity: 0.4; cursor: not-allowed; }

    .nav-counter {
        font-size: 14px;
        color: #95a5a6;
        font-weight: 600;
    }

    /* Explanation Panel (right side) */
    .explanation-panel {
        width: 0;
        min-width: 0;
        background: white;
        border-left: 1px solid #e8ecf1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.3s ease, min-width 0.3s ease;
    }

    .explanation-panel.open {
        width: 380px;
        min-width: 380px;
    }

    .explanation-panel-header {
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .explanation-panel-header h5 {
        font-size: 15px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .explanation-panel-header h5 i { color: #ff9f43; }

    .btn-close-explain {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: none;
        background: #f4f6f9;
        color: #7f8c8d;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
    }

    .btn-close-explain:hover { background: #ea5455; color: white; }

    .explanation-panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .explain-section {
        margin-bottom: 20px;
    }

    .explain-section-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .explain-section-title.question-explain { color: #667eea; }
    .explain-section-title.answer-explain { color: #28c76f; }
    .explain-section-title.answer-explain.wrong { color: #ea5455; }

    .explain-content {
        font-size: 14px;
        line-height: 1.7;
        color: #2c3e50;
        padding: 14px 16px;
        border-radius: 10px;
        background: #fafbfc;
        border: 1px solid #e8ecf1;
    }

    .explain-content p { margin: 0 0 8px 0; }
    .explain-content p:last-child { margin-bottom: 0; }

    .explain-answer-label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        margin-bottom: 8px;
        padding: 3px 10px;
        border-radius: 6px;
        font-size: 12px;
    }

    .explain-answer-label.correct-label { background: rgba(40,199,111,0.1); color: #28c76f; }
    .explain-answer-label.wrong-label { background: rgba(234,84,85,0.1); color: #ea5455; }
    .explain-answer-label.neutral-label { background: #f4f6f9; color: #7f8c8d; }

    .explain-no-content {
        font-size: 13px;
        color: #95a5a6;
        font-style: italic;
        padding: 14px 16px;
    }

    .btn-show-explain {
        padding: 6px 14px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 12px;
        border: 2px solid rgba(255,159,67,0.3);
        background: rgba(255,159,67,0.06);
        color: #ff9f43;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-show-explain:hover {
        background: #ff9f43;
        color: white;
        border-color: #ff9f43;
    }

    .explain-divider {
        border: none;
        border-top: 1px solid #e8ecf1;
        margin: 16px 0;
    }
</style>

<div class="take-page">
    <!-- Sidebar -->
    <div class="take-sidebar">
        <div class="sidebar-header">
            <h5><i class="fa fa-pencil-square-o"></i> Bài thi thử</h5>
            <p class="exam-title-text">@Model.Title</p>
        </div>

        <div class="sidebar-timer">
            <i class="fa fa-clock-o"></i>
            <span>Thời gian: </span>
            <span id="elapsed">00:00</span>
        </div>

        <div class="question-nav">
            <div class="question-nav-grid">
                @for (int i = 0; i < Model.Progress.Count; i++)
                {
                    var p = Model.Progress[i];
                    var cls = p.IsCurrent ? "current"
                            : p.IsCorrect == true ? "correct"
                            : p.IsCorrect == false ? "wrong"
                            : p.IsAnswered ? "answered"
                            : "";
                    <button class="qnav-btn @cls"
                            data-index="@i"
                            onclick="goToQuestion(@Model.ExamId, @i)"
                            title="Câu @(i + 1)@(p.IsAnswered ? (p.IsCorrect == true ? " ✓" : p.IsCorrect == false ? " ✗" : " (đã trả lời)") : "")">
                        @(i + 1)
                    </button>
                }
            </div>
        </div>

        <div class="sidebar-footer">
            @{
                var answered = Model.Progress.Count(p => p.IsAnswered);
                var pct = Model.TotalQuestions > 0 ? (int)((double)answered / Model.TotalQuestions * 100) : 0;
            }
            <div class="sidebar-progress">
                <span>Tiến độ</span>
                <span>@answered / @Model.TotalQuestions</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" style="width:@(pct)%"></div>
            </div>
            <button class="btn-finish-exam" onclick="finishExam()">
                <i class="fa fa-flag-checkered"></i> Nộp bài
            </button>
            <div class="sidebar-extra-actions">
                <button class="btn-sidebar-action btn-pause" onclick="pauseExam()">
                    <i class="fa fa-pause"></i> Tạm dừng
                </button>
                <button class="btn-sidebar-action btn-reset" onclick="resetExam()">
                    <i class="fa fa-refresh"></i> Thi lại
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="take-main">
        <div class="question-area">
            <div class="question-header">
                <div class="question-number">@(Model.CurrentIndex + 1)</div>
                <div class="question-meta">
                    <h3>Câu hỏi @(Model.CurrentIndex + 1)</h3>
                    <p>@(Model.CurrentQuestion.Title ?? "")</p>
                </div>
                <button class="btn-show-explain" onclick="toggleExplanationPanel()" title="Xem giải thích">
                    <i class="fa fa-lightbulb-o"></i> Giải thích
                </button>
            </div>

            <div class="question-text">
                @Html.Raw(Model.CurrentQuestion.Text)
            </div>

            @{
                var alreadyGraded = Model.CurrentQuestion.IsCorrect.HasValue;
            }
            <div class="answer-options" id="answerOptions">
                @foreach (var opt in Model.CurrentQuestion.Options)
                {
                    var sel = Model.CurrentQuestion.SelectedAnswerId.HasValue && Model.CurrentQuestion.SelectedAnswerId.Value == opt.AnswerId;
                    var gradedClass = "";
                    if (alreadyGraded)
                    {
                        if (opt.IsCorrect)
                        {
                            gradedClass = "graded correct-answer";
                        }
                        else if (sel && !opt.IsCorrect)
                        {
                            gradedClass = "graded wrong-selected";
                        }
                        else
                        {
                            gradedClass = "graded";
                        }
                    }
                    <label class="answer-option @(sel ? "selected" : "") @gradedClass"
                           data-aid="@opt.AnswerId"
                           data-correct="@opt.IsCorrect.ToString().ToLower()">
                        <input type="radio" name="selectedAnswer" value="@opt.AnswerId" @(sel ? "checked" : "") @(alreadyGraded ? "disabled" : "") />
                        <div class="answer-label">@opt.Label</div>
                        <div class="answer-text">@Html.Raw(opt.Text)</div>
                        <span class="answer-result-icon">
                            @if (opt.IsCorrect)
                            {
                                <i class="fa fa-check-circle"></i>
                            }
                            else if (sel && !opt.IsCorrect)
                            {
                                <i class="fa fa-times-circle"></i>
                            }
                        </span>
                    </label>
                }
            </div>

            <div class="grading-feedback" id="gradingFeedback"
                 @if (alreadyGraded)
                 {
                     if (Model.CurrentQuestion.IsCorrect == true)
                     {
                         <text>style="display:flex" class="grading-feedback correct"</text>
                     }
                     else
                     {
                         <text>style="display:flex" class="grading-feedback wrong"</text>
                     }
                 }>
                @if (alreadyGraded && Model.CurrentQuestion.IsCorrect == true)
                {
                    <i class="fa fa-check-circle"></i>
                    <span>Chính xác! Bạn đã trả lời đúng câu hỏi này.</span>
                }
                else if (alreadyGraded && Model.CurrentQuestion.IsCorrect == false)
                {
                    <i class="fa fa-times-circle"></i>
                    <span>Sai rồi! Hãy xem giải thích để hiểu rõ hơn.</span>
                }
            </div>
        </div>

        <div class="question-nav-buttons">
            <button class="btn-nav" onclick="navigate('prev')" @(Model.CurrentIndex <= 0 ? "disabled" : "")>
                <i class="fa fa-chevron-left"></i> Câu trước
            </button>
            <span class="nav-counter">@(Model.CurrentIndex + 1) / @Model.TotalQuestions</span>
            @if (Model.CurrentIndex < Model.TotalQuestions - 1)
            {
                <button class="btn-nav primary" onclick="navigate('next')">
                    Câu tiếp <i class="fa fa-chevron-right"></i>
                </button>
            }
            else
            {
                <button class="btn-nav primary" onclick="finishExam()">
                    <i class="fa fa-flag-checkered"></i> Nộp bài
                </button>
            }
        </div>
    </div>

    <!-- Explanation Panel (right side) -->
    <div class="explanation-panel" id="explanationPanel">
        <div class="explanation-panel-header">
            <h5><i class="fa fa-lightbulb-o"></i> Giải thích</h5>
            <button class="btn-close-explain" onclick="toggleExplanationPanel()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="explanation-panel-body">
            <!-- Question explanation -->
            <div class="explain-section">
                <div class="explain-section-title question-explain">
                    <i class="fa fa-question-circle"></i> Giải thích câu hỏi
                </div>
                @if (!string.IsNullOrEmpty(Model.CurrentQuestion.Explanation))
                {
                    <div class="explain-content">
                        @Html.Raw(Model.CurrentQuestion.Explanation)
                    </div>
                }
                else
                {
                    <div class="explain-no-content">Không có giải thích cho câu hỏi này.</div>
                }
            </div>

            <hr class="explain-divider" />

            <!-- Answer explanations -->
            @foreach (var opt in Model.CurrentQuestion.Options)
            {
                if (!string.IsNullOrEmpty(opt.Explanation))
                {
                    var labelClass = opt.IsCorrect ? "correct-label" : "neutral-label";
                    var sectionClass = opt.IsCorrect ? "answer-explain" : "answer-explain wrong";
                    <div class="explain-section">
                        <div class="explain-section-title @sectionClass">
                            <span class="explain-answer-label @labelClass">
                                @opt.Label
                                @if (opt.IsCorrect)
                                {
                                    <i class="fa fa-check"></i>
                                }
                            </span>
                        </div>
                        <div class="explain-content">
                            @Html.Raw(opt.Explanation)
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@using (Html.BeginForm("SubmitAnswer", "Exam", FormMethod.Post, new { id = "hiddenForm", style = "display:none" }))
{
    @Html.AntiForgeryToken()
}

@section Scripts {
    <script type="text/javascript">
        var examId = @Model.ExamId;
        var questionId = @Model.CurrentQuestion.QuestionId;
        var currentIndex = @Model.CurrentIndex;
        var startTime = new Date('@(Model.StartedAt.ToVietnamTime().ToString("yyyy-MM-ddTHH:mm:ss"))');
        var isGraded = @(Model.CurrentQuestion.IsCorrect.HasValue ? "true" : "false");

        // Timer
        function updateTimer() {
            var now = new Date();
            var diff = Math.floor((now - startTime) / 1000);
            var h = Math.floor(diff / 3600);
            var m = Math.floor((diff % 3600) / 60);
            var s = diff % 60;
            var str = (h > 0 ? h + ':' : '') + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
            $('#elapsed').text(str);
        }
        setInterval(updateTimer, 1000);
        updateTimer();

        // Select answer — triggers immediate grading
        $(document).on('click', '.answer-option', function () {
            if (isGraded) return;

            $('.answer-option').removeClass('selected');
            $(this).addClass('selected');
            $(this).find('input[type="radio"]').prop('checked', true);

            // Submit for immediate grading
            var selectedId = parseInt($(this).find('input[type="radio"]').val());
            gradeAnswer(selectedId);
        });

        function gradeAnswer(selectedId) {
            if (isGraded) return;

            var data = {
                __RequestVerificationToken: getToken(),
                examId: examId,
                questionId: questionId,
                selectedAnswerId: selectedId,
                action: 'grade'
            };

            $.post('@Url.Action("SubmitAnswer", "Exam")', data, function (res) {
                if (!res.success) return;

                isGraded = true;
                var correct = res.isCorrect === true;

                // Update answer options visually
                $('#answerOptions .answer-option').each(function () {
                    var $opt = $(this);
                    var isCorrectAnswer = $opt.data('correct') === true || $opt.data('correct') === 'true';
                    var isSelected = $opt.hasClass('selected');

                    $opt.addClass('graded');
                    $opt.find('input[type="radio"]').prop('disabled', true);

                    if (isCorrectAnswer) {
                        $opt.addClass('correct-answer');
                        $opt.find('.answer-result-icon').html('<i class="fa fa-check-circle"></i>').show();
                    } else if (isSelected && !isCorrectAnswer) {
                        $opt.addClass('wrong-selected');
                        $opt.find('.answer-result-icon').html('<i class="fa fa-times-circle"></i>').show();
                    }
                });

                // Show feedback banner
                var $fb = $('#gradingFeedback');
                $fb.removeClass('correct wrong');
                if (correct) {
                    $fb.addClass('correct').html('<i class="fa fa-check-circle"></i> <span>Chính xác! Bạn đã trả lời đúng câu hỏi này.</span>');
                } else {
                    $fb.addClass('wrong').html('<i class="fa fa-times-circle"></i> <span>Sai rồi! Hãy xem giải thích để hiểu rõ hơn.</span>');
                }
                $fb.css('display', 'flex');

                // Update nav button color for current question
                var $btn = $('.qnav-btn[data-index="' + currentIndex + '"]');
                $btn.removeClass('current answered');
                $btn.addClass(correct ? 'correct' : 'wrong');
            });
        }

        function getToken() {
            return $('#hiddenForm input[name="__RequestVerificationToken"]').val();
        }

        function getSelectedAnswer() {
            var checked = $('input[name="selectedAnswer"]:checked');
            return checked.length ? parseInt(checked.val()) : null;
        }

        // Toggle explanation panel
        function toggleExplanationPanel() {
            $('#explanationPanel').toggleClass('open');
        }

        // Navigate prev/next
        function navigate(action) {
            var data = {
                __RequestVerificationToken: getToken(),
                examId: examId,
                questionId: questionId,
                selectedAnswerId: getSelectedAnswer(),
                action: action
            };
            $.post('@Url.Action("SubmitAnswer", "Exam")', data, function (res) {
                if (res.success) {
                    window.location.href = res.redirectUrl;
                }
            });
        }

        // Go to specific question
        function goToQuestion(eid, idx) {
            var data = {
                __RequestVerificationToken: getToken(),
                examId: examId,
                questionId: questionId,
                selectedAnswerId: getSelectedAnswer(),
                action: 'save'
            };
            $.post('@Url.Action("SubmitAnswer", "Exam")', data, function () {
                $.post('@Url.Action("GoToQuestion", "Exam")', {
                    __RequestVerificationToken: getToken(),
                    examId: eid,
                    index: idx
                }, function (res) {
                    if (res.success) {
                        window.location.href = res.redirectUrl;
                    }
                });
            });
        }

        // Finish exam
        function finishExam() {
            var unanswered = $('.qnav-btn').not('.correct').not('.wrong').not('.answered').not('.current').length;
            var currentAnswered = getSelectedAnswer() !== null;
            if (!currentAnswered && !isGraded) unanswered++;

            var msg = 'Bạn có chắc muốn nộp bài?';
            if (unanswered > 0) {
                msg = 'Còn ' + unanswered + ' câu chưa trả lời. Bạn có chắc muốn nộp bài?';
            }
            if (!confirm(msg)) return;

            var saveData = {
                __RequestVerificationToken: getToken(),
                examId: examId,
                questionId: questionId,
                selectedAnswerId: getSelectedAnswer(),
                action: 'save'
            };
            $.post('@Url.Action("SubmitAnswer", "Exam")', saveData, function () {
                $.post('@Url.Action("FinishPractice", "Exam")', {
                    __RequestVerificationToken: getToken(),
                    examId: examId
                }, function (res) {
                    if (res.success) {
                        window.location.href = res.redirectUrl;
                    }
                });
            });
        }

        // Pause exam
        function pauseExam() {
            var saveData = {
                __RequestVerificationToken: getToken(),
                examId: examId,
                questionId: questionId,
                selectedAnswerId: getSelectedAnswer(),
                action: 'save'
            };
            $.post('@Url.Action("SubmitAnswer", "Exam")', saveData, function () {
                window.location.href = '@Url.Action("PracticeExam", "Exam")';
            });
        }

        // Reset exam
        function resetExam() {
            if (!confirm('Bạn có chắc muốn thi lại? Tất cả câu trả lời sẽ bị xóa trắng.')) return;
            $.post('@Url.Action("ResetPractice", "Exam")', {
                __RequestVerificationToken: getToken(),
                examId: examId
            }, function (res) {
                if (res.success) {
                    window.location.href = res.redirectUrl;
                } else {
                    alert(res.message || 'Không thể thi lại.');
                }
            });
        }
    </script>
}
