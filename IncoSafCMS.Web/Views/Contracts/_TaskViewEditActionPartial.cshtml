@{
    int? departmentId = ViewBag.departmentId;
}
@{
    var grid = Html.DevExpress().GridView(settings =>
    {
        settings.Name = "grvTaskEditAction";
        settings.CallbackRouteValues = new
        {
            Controller = "Contracts",
            Action = "TaskViewEditActionPartial"
        };

        settings.SettingsEditing.AddNewRowRouteValues = new { Controller = "Contracts", Action = "TaskViewEditActionPartialAddNew" };
        settings.SettingsEditing.UpdateRowRouteValues = new { Controller = "Contracts", Action = "TaskViewEditActionPartialUpdate" };
        settings.SettingsEditing.DeleteRowRouteValues = new { Controller = "Contracts", Action = "TaskViewEditActionPartialDelete" };

        settings.SettingsText.CommandNew = "Thêm";
        settings.SettingsText.CommandEdit = "Sửa";
        settings.SettingsText.CommandDelete = "Xóa";
        settings.SettingsText.PopupEditFormCaption = "Thêm/Sửa dữ liệu";
        settings.SettingsText.SearchPanelEditorNullText = "Nhập từ khóa tìm kiếm...";
        settings.SettingsText.EmptyDataRow = "Không có kết quả nào";
        settings.CommandColumn.VisibleIndex = 9;
        settings.CommandColumn.Caption = " ";
        settings.CommandColumn.Width = System.Web.UI.WebControls.Unit.Pixel(60);
        settings.Width = System.Web.UI.WebControls.Unit.Percentage(100);
        settings.SettingsLoadingPanel.Text = "Đang tải...";

        settings.Styles.Header.Paddings.PaddingTop = System.Web.UI.WebControls.Unit.Pixel(2);
        settings.Styles.Header.Paddings.PaddingBottom = System.Web.UI.WebControls.Unit.Pixel(2);
        settings.Styles.Header.BackColor = System.Drawing.ColorTranslator.FromHtml("#5681CE");
        settings.Styles.Header.ForeColor = System.Drawing.Color.White;
        settings.Styles.Header.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;
        settings.Styles.Cell.Paddings.PaddingTop = System.Web.UI.WebControls.Unit.Pixel(1);
        settings.Styles.Cell.Paddings.PaddingBottom = System.Web.UI.WebControls.Unit.Pixel(1);
        settings.ControlStyle.Border.BorderStyle = System.Web.UI.WebControls.BorderStyle.None;

        settings.Styles.Footer.Paddings.PaddingTop = System.Web.UI.WebControls.Unit.Pixel(1);
        settings.Styles.Footer.Paddings.PaddingBottom = System.Web.UI.WebControls.Unit.Pixel(1);

        settings.SettingsPager.Summary.EmptyText = "Không có dữ liệu để đánh số trang";
        settings.SettingsPager.Summary.AllPagesText = "Trang {0}/{1} ({2} kết quả)";
        settings.SettingsPager.Summary.Text = "Trang {0}/{1} ({2} kết quả)";
        settings.SettingsPager.PageSize = 5;
        settings.SettingsBehavior.AllowFocusedRow = true;
        settings.SettingsPager.AllButton.Visible = false;
        settings.SettingsPager.LastPageButton.Visible = false;
        settings.SettingsPager.FirstPageButton.Visible = false;

        settings.SettingsEditing.Mode = GridViewEditingMode.EditFormAndDisplayRow;
        settings.SettingsBehavior.ConfirmDelete = true;

        settings.CommandColumn.Visible = true;
        settings.CommandColumn.ShowNewButton = true;
        settings.CommandColumn.ShowDeleteButton = true;
        settings.CommandColumn.ShowEditButton = true;

        settings.KeyFieldName = "Id";

        settings.SettingsPager.Visible = true;
        settings.Settings.ShowGroupPanel = false;
        settings.Settings.ShowFilterRow = false;
        settings.SettingsBehavior.AllowSelectByRowClick = false;

        settings.Columns.Add(column =>
        {
            column.Caption = "STT";
            column.FieldName = "STT";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(20);
            column.EditFormSettings.Visible = DefaultBoolean.False;
            column.UnboundType = DevExpress.Data.UnboundColumnType.Integer;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "ID";
            column.FieldName = "Id";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Visible = false;
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "Nội dung công việc";
            column.FieldName = "Name";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.UnboundType = DevExpress.Data.UnboundColumnType.String;
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "Đ.vị";
            column.FieldName = "Unit";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(20);
            column.UnboundType = DevExpress.Data.UnboundColumnType.String;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "K.lượng";
            column.FieldName = "Amount";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(20);
            column.PropertiesEdit.DisplayFormatString = "N1";
            column.UnboundType = DevExpress.Data.UnboundColumnType.Integer;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "Đơn giá_cóVAT";
            column.FieldName = "UnitPrice";
            column.Visible = false;
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(100);
            column.PropertiesEdit.DisplayFormatString = "N0";
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;

            column.ColumnType = MVCxGridViewColumnType.SpinEdit;

            var prop = column.PropertiesEdit as SpinEditProperties;
            prop.DisplayFormatString = "N0";
            prop.ClientInstanceName = "txtUnitPrice";

            // ❌ Bỏ nút mũi tên
            prop.SpinButtons.ShowIncrementButtons = false;

            // ❌ Chặn lăn chuột
            prop.AllowMouseWheel = false;

            prop.ClientSideEvents.ValueChanged =
                "function(s, e) { onUnitPriceChanged(); }";
        });


        settings.Columns.Add(column =>
        {
            column.Caption = "Đ.giá_noVAT";
            column.FieldName = "UnitPrice_noVAT";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(100);
            column.PropertiesEdit.DisplayFormatString = "N0";
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;

            column.ColumnType = MVCxGridViewColumnType.SpinEdit;

            var prop = column.PropertiesEdit as SpinEditProperties;
            prop.DisplayFormatString = "N0";
            prop.ClientInstanceName = "txtUnitPriceNoVAT";

            // ❌ Bỏ nút mũi tên
            prop.SpinButtons.ShowIncrementButtons = false;

            // ❌ Chặn lăn chuột
            prop.AllowMouseWheel = false;

            prop.ClientSideEvents.ValueChanged =
                "function(s, e) { onUnitPriceNoVATChanged(); }";

        });

        settings.Columns.Add(column =>
        {
            column.Caption = "Thành tiền";
            column.FieldName = "Total";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(100);
            column.PropertiesEdit.DisplayFormatString = "N0";
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Right;
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "Loại thuế";
            column.FieldName = "vatType";
            column.Width = System.Web.UI.WebControls.Unit.Pixel(100);
            column.PropertiesEdit.DisplayFormatString = "N0";
            column.Visible = false;
            column.ColumnType = MVCxGridViewColumnType.ComboBox;
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;

            ComboBoxProperties c = column.PropertiesEdit as ComboBoxProperties;
            c.ClientInstanceName = "cmbTaskVATType";
            c.Items.Add("Có thuế", IncosafCMS.Core.DomainModels.VATType.cothue);
            c.Items.Add("Không thuế", IncosafCMS.Core.DomainModels.VATType.khongthue);
            c.ClientSideEvents.SelectedIndexChanged =
            "function(s, e) { cmbTaskVAT.SetEnabled(cmbTaskVATType.GetSelectedIndex() === 0); cmbTaskVAT.SetValue(cmbTaskVATType.GetSelectedIndex() === 0 ? 8 : 0); recalcUnitPrice(); }";
        });

        settings.Columns.Add(column =>
        {
            column.Caption = "% VAT";
            column.FieldName = "VAT";
            column.Width = System.Web.UI.WebControls.Unit.Pixel(30);
            column.PropertiesEdit.DisplayFormatString = "N0";

            column.ColumnType = MVCxGridViewColumnType.ComboBox;
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;

            ComboBoxProperties c = column.PropertiesEdit as ComboBoxProperties;
            c.ClientInstanceName = "cmbTaskVAT";
            c.Items.Add("8%", 8);
            c.Items.Add("10%", 10);
            c.Items.Add("5%", 5);
            c.Items.Add("0%", 0);

            c.ClientSideEvents.ValueChanged =
                "function(s, e) { onUnitPriceChanged(); }";
        });

        // 10/08/2024 thêm cột khoán công ty ở chi tiết công việc
        settings.Columns.Add(column =>
        {
            column.Caption = "% K.Cty";
            column.FieldName = "Tyle1";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(30);
            column.PropertiesEdit.DisplayFormatString = "N1";   // can thiệp vào textbox để đổi dấu , --> . ở `settings.CellEditorInitialize`
            column.SetDataItemTemplateContent(cell =>
            {
                if (!string.IsNullOrWhiteSpace(cell.Text))
                    ViewContext.Writer.Write("<span class=\"badge badge-info\">" + cell.Text.Replace(',', '.') + "</span>");

            });
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;     // Integer
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;

            // chỉ cho Qly & Ktoan nhập. Chặn KĐV
            if (User.IsInRole("Admin") || User.IsInRole("Accountant"))     // User.IsInRole("DeptDirector") ||
                column.ReadOnly = false;
            else
                column.ReadOnly = true;

            // có thể can thiệp vào đối tượng cụ thể bằng cách này thì chi tiết hơn. Còn k0 thì dùng các thuộc tính có sẵn ở trên là ok
            //TextBoxProperties t = column.PropertiesEdit as TextBoxProperties;
            //t.ClientInstanceName = "Tyle1";
            //t.DisplayFormatString = "N1";
            //t.DisplayFormatInEditMode = true;
            //t.MaskSettings.UseInvariantCultureDecimalSymbolOnClient = false;

        });

        // 03-jan-2024 added by lapbt. Show tỷ lệ khoán cá nhân AccTaskGroup --> 10/08/2024 đổi sang Tyle2
        settings.Columns.Add(column =>
        {
            column.Caption = "% K.CN";
            column.FieldName = "Tyle2";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.Width = System.Web.UI.WebControls.Unit.Pixel(30);
            column.PropertiesEdit.DisplayFormatString = "N1";
            column.SetDataItemTemplateContent(cell =>
            {
                if (!string.IsNullOrWhiteSpace(cell.Text))
                    ViewContext.Writer.Write("<span class=\"badge badge-info\">" + cell.Text.Replace(',', '.') + "</span>");

            });
            column.UnboundType = DevExpress.Data.UnboundColumnType.Decimal;     // Integer
            column.CellStyle.HorizontalAlign = System.Web.UI.WebControls.HorizontalAlign.Center;

            // chỉ cho Qly & Ktoan nhập. KĐV nhập khi chưa cấp số --> k0 xly ở client do k0 có Model.MaHD, xly kiểm tra ở đầu server, sẽ k0 update trường này nếu là KĐV
            //if (User.IsInRole("Admin") || User.IsInRole("Accountant") || string.IsNullOrEmpty(Model.MaHD))
            //    column.ReadOnly = false;
            //else
            //    column.ReadOnly = true;
        });


        settings.Columns.Add(column =>
        {
            column.Caption = "Loại hình";
            column.FieldName = "AccTaskNote";
            column.Settings.AllowSort = DefaultBoolean.False;
            column.UnboundType = DevExpress.Data.UnboundColumnType.String;
            column.ColumnType = MVCxGridViewColumnType.ComboBox;
            column.Visible = false;
            column.ShowInCustomizationForm = true;

            ComboBoxProperties c = column.PropertiesEdit as ComboBoxProperties;
            c.ClientInstanceName = "cmbAccTaskNote";
            c.Items.Add("KĐXD-TBN: KĐ an toàn TB nâng", "KĐXD-TBN");
            c.Items.Add("KĐXD-TBAL: KĐ an toàn TB áp lực", "KĐXD-TBAL");
            c.Items.Add("KĐXD-TBTC: KĐ TB thi công - Công nghệ", "KĐXD-TBTC"); //TC.CN
            c.Items.Add("KĐXD-HQ: Chứng nhận hợp quy", "KĐXD-HQ");
            c.Items.Add("KĐXD-AK: KĐ áp kế", "KĐXD-AK");
            c.Items.Add("KĐXD-HL: Huấn luyện ATVSLĐ", "KĐXD-HL");
            c.Items.Add("KĐXD-TVXD: KĐ Tư vấn XD", "KĐXD-TVXD");
            c.Items.Add("KĐXD-TNHT: Thí nghiệm tại hiện trường", "KĐXD-TNHT");
            c.Items.Add("KĐXD-TNPTN: Thí nghiệm tại Phòng TN", "KĐXD-TNPTN");
            c.Items.Add("KĐXD-KHAC: Loại hình khác", "KĐXD-KHAC");
        });

        settings.EditFormLayoutProperties.ColCount = 2;
        settings.EditFormLayoutProperties.Items.Add("Name");
        settings.EditFormLayoutProperties.Items.Add("Unit");
        settings.EditFormLayoutProperties.Items.Add("Amount");
        settings.EditFormLayoutProperties.Items.Add("UnitPrice");
        settings.EditFormLayoutProperties.Items.Add("vatType");
        settings.EditFormLayoutProperties.Items.Add("UnitPrice_noVAT");//thêm 5.2.2026
        settings.EditFormLayoutProperties.Items.Add("Tyle1");
        settings.EditFormLayoutProperties.Items.Add("VAT");
        settings.EditFormLayoutProperties.Items.Add("Tyle2");   // AccTaskGroup
        settings.EditFormLayoutProperties.Items.Add("AccTaskNote").RequiredMarkDisplayMode = FieldRequiredMarkMode.Required;
        settings.EditFormLayoutProperties.Items.AddCommandItem(itemSettings =>
        {
            itemSettings.ColSpan = 2;
            itemSettings.HorizontalAlign = FormLayoutHorizontalAlign.Right;
        });

        // 03-jan-2024 added by lapbt. Process the initialization of new rows. Mặc định tỷ lệ khoán 52 khi add new task
        settings.InitNewRow = (s, e) =>
        {
            e.NewValues["vatType"] = IncosafCMS.Core.DomainModels.VATType.cothue; //Mặc định là có thuế
            e.NewValues["VAT"] = 8; // Mặc định VAT = 8

            if (departmentId == 8 || departmentId == 10)
            {
                e.NewValues["Tyle1"] = 83.7; // Fix tyle theo khu vuc: HCM/ĐN 83.7
                e.NewValues["Tyle2"] = 52; // Fix tyle theo khu vuc: HCM/ĐN 52
            }
            else
            {
                e.NewValues["Tyle1"] = 77; // Fix tyle theo khu vuc: HN 80
                e.NewValues["Tyle2"] = 51; // Fix tyle theo khu vuc: HN 51
            }

            //e.NewValues["Tyle1"] = System.Configuration.ConfigurationManager.AppSettings["RatioOfCompany"];
            //e.NewValues["Tyle2"] = System.Configuration.ConfigurationManager.AppSettings["RatioOfInternal"];     // AccTaskGroup "52";
        };

        //5.2.2026 thêm 3 dòng footer hiển thị Tổng tiền chưa VAT; tiền VAT; Tổng cộng
        settings.Settings.ShowFooter = true;
        settings.Styles.Footer.BackColor = System.Drawing.ColorTranslator.FromHtml("#F5F5F5");
        decimal sumNoVat = 0;
        decimal sumVat = 0;

        var sumTotal = new DevExpress.Web.ASPxSummaryItem()
        {
            FieldName = "Total",
            SummaryType = DevExpress.Data.SummaryItemType.Sum,
            ShowInColumn = "Total",
            DisplayFormat = "{0:N0}"
        };
        settings.TotalSummary.Add(sumTotal);

        var sumVAT = new DevExpress.Web.ASPxSummaryItem()
        {
            FieldName = "VAT",
            SummaryType = DevExpress.Data.SummaryItemType.Custom,
            ShowInColumn = "Total",
            DisplayFormat = "{0:N0}"
        };
        settings.TotalSummary.Add(sumVAT);

        var sumTotalWithVAT = new DevExpress.Web.ASPxSummaryItem()
        {
            FieldName = "TotalWithVAT",
            SummaryType = DevExpress.Data.SummaryItemType.Custom,
            ShowInColumn = "Total",
            DisplayFormat = "{0:N0}"
        };
        settings.TotalSummary.Add(sumTotalWithVAT);

        settings.CustomSummaryCalculate = (sender, e) =>
        {
            if (e.SummaryProcess == DevExpress.Data.CustomSummaryProcess.Start)
            {
                sumNoVat = 0;
                sumVat = 0;
            }

            if (e.SummaryProcess == DevExpress.Data.CustomSummaryProcess.Calculate)
            {
                decimal total = Convert.ToDecimal(e.GetValue("Total") ?? 0);
                decimal vat = Convert.ToDecimal(e.GetValue("VAT") ?? 0);

                sumNoVat += total;
                sumVat += total * vat / 100;
            }


            if (e.SummaryProcess == DevExpress.Data.CustomSummaryProcess.Finalize)
            {
                var item = e.Item as DevExpress.Web.ASPxSummaryItem;
                if (item == null) return;

                if (item.FieldName == "VAT")
                    e.TotalValue = sumVat;

                if (item.FieldName == "TotalWithVAT")
                    e.TotalValue = sumNoVat + sumVat;
            }

        };

        var nameCol = settings.Columns["Name"] as MVCxGridViewColumn;
        if (nameCol != null)
        {
            nameCol.SetFooterTemplateContent(c =>
            {
                ViewContext.Writer.Write(@"
                <div style='
                    line-height:20px;
                    text-align:left;
                    margin-top:1px;
                    padding-top:1px;
                '>
                    <div style='margin-top: 0px; color: DarkBlue'> <b>Tổng tiền chưa VAT</b> </div>
                    <div style='color: DarkBlue'> Thuế VAT </div>
                    <div style='margin-bottom: 0px; color: Blue'> <b>Tổng tiền có VAT</b> </div>
                </div>
                ");
            });
        }

        var totalCol = settings.Columns["Total"] as MVCxGridViewColumn;
        if (totalCol != null)
        {           
            totalCol.SetFooterTemplateContent(c =>
            {
                var gridView = (MVCxGridView)c.Grid;

                var footerSumNoVat = gridView.GetTotalSummaryValue(gridView.TotalSummary["Total"]);
                var footerSumVat = gridView.GetTotalSummaryValue(gridView.TotalSummary["VAT"]);
                var footerSumWithVat = Convert.ToDouble(footerSumNoVat) + Convert.ToDouble(footerSumVat);

                ViewContext.Writer.Write(
                    string.Format(@"
                    <div style='
                        line-height:20px;
                        text-align:right;
                        margin-top:1px;
                        padding-top:1px;
                    '>
                        <div style='margin-top: 0px; color: DarkBlue'><b>{0:N0}</b></div>
                        <div style='color: DarkBlue'>{1:N0}</div>
                        <div style='margin-bottom: 0px; color: Blue'><b>{2:N0}</b></div>
                    </div>",
                    footerSumNoVat,
                    footerSumVat,
                    footerSumWithVat
                ));
            });

        }


        settings.BeforeGetCallbackResult = (sender, e) =>
        {
            MVCxGridView gridView = sender as MVCxGridView;
            if (gridView.IsNewRowEditing)
            {
                gridView.SettingsText.CommandUpdate = "Lưu lại";
                gridView.SettingsText.CommandCancel = "Hủy bỏ";
            }
            else
            {
                gridView.SettingsText.CommandUpdate = "Cập nhật";
                gridView.SettingsText.CommandCancel = "Hủy bỏ";
            }
        };

        settings.CustomColumnDisplayText = (sender, e) =>
        {
            if (e.Column.FieldName == "STT")
            {
                if (e.VisibleIndex < 0)
                {
                    e.DisplayText = " ";
                }
                else
                {
                    var i = e.VisibleIndex + 1;
                    e.DisplayText = (i).ToString();
                }
            }
        };

        // đây là cách để chỉnh hiển thị giá trị ở grid, có thể dùng cách này, hoặc ở trên kia xly vào `cell.Text` luôn
        //settings.CustomColumnDisplayText = (s, e) =>
        //{
        //    if (e.Column.FieldName == "Tyle1")
        //    {
        //        //var currency = e.Column.Grid.GetRowValues(e.VisibleIndex, "Currency");
        //        //if (currency == null) return;
        //        e.DisplayText = e.Value.ToString().Replace(',','.');
        //    }
        //};

        settings.PreRender = (sender, e) =>
        {
            //((MVCxGridView)sender).StartEdit(1);
        };

        settings.CellEditorInitialize = (s, e) =>
        {
            ASPxEdit editor = (ASPxEdit)e.Editor;
            editor.ValidationSettings.Display = Display.Dynamic;

            //MVCxGridView gridViewControl = (MVCxGridView)s;
            //if (gridViewControl.IsNewRowEditing) return;
            if (e.Value != null && !string.IsNullOrWhiteSpace(e.Value.ToString()) && (e.Column.FieldName == "Tyle1" || e.Column.FieldName == "Tyle2"))
            {
                editor.Value = e.Value.ToString().Replace(',', '.');
            }

            // bản chất chỗ số thập phân này là
            // - số ở db sẽ là xx.x là kiểu format EU
            // - tuy nhiên grid chạy ở máy chủ đặt region = VN dẫn tới format là xx,x theo format VN
            // => do đó can thiệp ở mothod này để đổi lại giá trị thành chuỗi và đổi dấu, cách này sẽ sai nếu nhập vào > 1000.x
        };


    });
    if (ViewData["EditError"] != null)
    {
        grid.SetEditErrorText((string)ViewData["EditError"]);
    }
}
@grid.Bind(Model).GetHtml()

<script type="text/javascript">
    var isCalculating = false;

    function round2(value) {
        if (value === null || value === undefined || isNaN(value)) return null;
        return Math.round(value * 100) / 100;
    }

    function getVAT() {
        var vat = cmbTaskVAT.GetValue();
        return vat ? parseFloat(vat) : 0;
    }

    function onUnitPriceNoVATChanged() {
        if (isCalculating) return;
        isCalculating = true;

        var noVat = txtUnitPriceNoVAT.GetValue();
        var vat = getVAT();

        if (noVat != null) {
            var price = noVat * (1 + vat / 100);

            txtUnitPriceNoVAT.SetValue(round2(noVat));
            txtUnitPrice.SetValue(round2(price));
        }

        isCalculating = false;
    }

    function onUnitPriceChanged() {
        if (isCalculating) return;
        isCalculating = true;

        var price = txtUnitPrice.GetValue();
        var vat = getVAT();

        if (price != null && vat >= 0) {
            var noVat = price / (1 + vat / 100);

            txtUnitPrice.SetValue(round2(price));
            txtUnitPriceNoVAT.SetValue(round2(noVat));
        }

        isCalculating = false;
    }

    function recalcByVAT() {
        var noVat = txtUnitPriceNoVAT.GetValue();
        var price = txtUnitPrice.GetValue();

        if (noVat != null && noVat > 0) {
            onUnitPriceNoVATChanged();
        }
        else if (price != null && price > 0) {
            onUnitPriceChanged();
        }
    }

    function recalcUnitPrice() {
        var vat = getVAT();
        var price = txtUnitPrice.GetValue();
        var priceNoVat = txtUnitPriceNoVAT.GetValue();

        if (priceNoVat != null && priceNoVat > 0) {
            txtUnitPrice.SetValue(round2(priceNoVat * (1 + vat / 100)));
        }
        else if (price != null && price > 0) {
            txtUnitPriceNoVAT.SetValue(round2(price / (1 + vat / 100)));
        }
    }
   
</script>

